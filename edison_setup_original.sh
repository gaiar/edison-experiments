#!/bin/sh -x

# =================================================================
#  Автоматическая настройка вместо configure_edison --setup
# =================================================================

# ---------------------------------------------------------------
# 1. hostname
# Set the HOSTNAME to edison, and wireless LAN access point to edison Also set to hostapd to be in
# . Edison.local further Bonjour
# To restart the mDNS to be able to access.
# If you host name access Bonjour Mac does not need anything,
# Windows download and install Bonjour from Apple,
# If you had Linux put a per Avahi.



HOSTNAME="edison"

HOSTNAME_FILE=/etc/hostname
HOSTAPD_FILE=/etc/hostapd/hostapd.conf
echo $HOSTNAME > $HOSTNAME_FILE
hostname -F $HOSTNAME_FILE
sed -i "s/^ssid=.*/ssid=$HOSTNAME/" $HOSTAPD_FILE
systemctl restart mdns
sleep 2

# ---------------------------------------------------------------
# 2. root password
# Edison?Linux???IoT???????????????????????
# ??????????????????????????????

PASSWORD="passw0rdPA55Word"

# chpasswd????????????:????????????
# ????????????????????????????
# ????????
echo "root:$PASSWORD" | chpasswd

# ---------------------------------------------------------------
# 3. Wi-Fi
# Wi-Fi???????configure_edison --wifi ???????????
# /etc/wpa_supplicant/wpa_supplicant.conf ??
# /home/root/wpa_supplicant.conf ?????????????????
# ???????????????????

MY_WPASUPP_FILE=/home/root/wpa_supplicant.conf

WPASUPP_FILE=/etc/wpa_supplicant/wpa_supplicant.conf
\cp $WPASUPP_FILE $WPASUPP_FILE.original
\cp $MY_WPASUPP_FILE $WPASUPP_FILE
# wpa_supplicant.conf????PreSharedKey?????????????
# ????root?????????????????
chmod 600 $WPASUPP_FILE
# Edison????hostapd????????????????????Edison
# ???LAN??????????????hostapd????????????
# ???????
systemctl stop hostapd
systemctl disable hostapd
# ??LAN????wpa_supplicant??????
# hostapd??????????wpa_supplicant?????????
systemctl restart wpa_supplicant
systemctl enable wpa_supplicant
# ??wpa_supplicant?????????????????????????
#wpa_cli reconfigure
# ??LAN????????????????????
sleep 5
# ??????LAN?????????????wlan0?
WLAN=`wpa_cli ifname | tail -n 1`
# ??2??wpa_supplicant.conf?SSID????????????????OK
wpa_cli list_networks
wpa_cli select_network 0
# ??LAN????????????????DHCP???LAN?IP???
udhcpc -i $WLAN -n


# ---------------------------------------------------------------
# 4. sshd
# Edison????USB????????????sshd???????????
# ?????????????

sed -i 's/^BindToDevice=/# BindToDevice=/g' /lib/systemd/system/sshd.socket
sync
systemctl daemon-reload;
systemctl restart sshd.socket

# =================================================================
# Edison ????
# ?????????okpg???????
# =================================================================

# ---------------------------------------------------------------
# Edison Linux?Timezone????ls?????????????????
# ????2?????
# # rm /etc/localtime;
# # ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
# Edison????????Systemd?timedatectl????????????
# ????ntpdate???Systemd???
# ???? http://qiita.com/CLCL/items/e991e23f4bdbca5ff28b

TIMEZONE="Europe/Moscow"

timedatectl set-timezone $TIMEZONE

# ---------------------------------------------------------------
# /var/log/journal ??????? ??Linux 2015.1

JURNALD_ADD='SystemMaxUse=4M';
JURNALD_CONF=/etc/systemd/journald.conf
\grep -e "^$JURNALD_ADD" $JURNALD_CONF
if [ $? == 1 ] ; then
  cat << EOS >> $JURNALD_CONF
$JURNALD_ADD
EOS

  systemctl stop systemd-journald
  \rm -rf /var/log/journal/*
  systemctl start systemd-journald
fi

# ---------------------------------------------------------------
# Edison????????
# http://qiita.com/yoneken/items/1b24f0dd8ae00579a0c2

OPKG_BASEFEEDS=/etc/opkg/base-feeds.conf
if [ ! -s $OPKG_BASEFEEDS ] ; then
  cat << EOS > $OPKG_BASEFEEDS
src/gz all http://repo.opkg.net/edison/repo/all
src/gz edison http://repo.opkg.net/edison/repo/edison
src/gz core2-32 http://repo.opkg.net/edison/repo/core2-32
EOS

fi

OPKG_INTELIOTDK=/etc/opkg/intel-iotdk.conf
if [ ! -s $OPKG_INTELIOTDK ] ; then
  cat << EOS > $OPKG_INTELIOTDK
src intel-iotdk http://iotdk.intel.com/repos/1.1/intelgalactic
src intel-all http://iotdk.intel.com/repos/1.1/iotdk/all
src intel-i586 http://iotdk.intel.com/repos/1.1/iotdk/i586
src intel-x86 http://iotdk.intel.com/repos/1.1/iotdk/x86
EOS

fi

# ---------------------------------------------------------------
# ?????????????????????
opkg update
opkg upgrade


# =================================================================
# ?????????????????
# http://dev.classmethod.jp/hardware/10-edison-package-manager-opkg/
# =================================================================

# ---------------------------------------------------------------
# Git ??????????????????
opkg install git
git config --global user.email "gaiar@baimuratov.ru"
git config --global user.name "gaiar"
git config --global color.ui auto

# ---------------------------------------------------------------
# bash
opkg install bash
chsh -s /bin/bash

# ---------------------------------------------------------------
# rsync
opkg install rsync

# ---------------------------------------------------------------
# vim
opkg install vim

# ???github??????clone????????
# npm???????????????
# ?????????kick???
# ?????????????????????